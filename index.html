<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FoodFinder — Image to Nearby Restaurants</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--muted:#69707a;--accent:#0b74de}
    *{box-sizing:border-box}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#102027}
    header{background:linear-gradient(90deg,#ffffffcc, #f3f6fb); padding:18px 28px; display:flex; align-items:center; gap:18px; border-bottom:1px solid #e6eef6}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:46px; height:46px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#2bb673); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700}
    .title{font-size:18px; font-weight:600}
    .subtitle{font-size:12px; color:var(--muted)}
    main{padding:24px; max-width:1200px; margin:24px auto; display:grid; grid-template-columns:420px 1fr; gap:20px}
    .card{background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(16,32,39,0.06); padding:18px}
    .uploader{display:flex; flex-direction:column; gap:12px}
    .dropzone{border:2px dashed #e3eefc; border-radius:12px; padding:22px; text-align:center; cursor:pointer}
    .dropzone.drag{border-color:var(--accent); background:#f0f8ff}
    .preview{width:100%; height:220px; object-fit:cover; border-radius:8px; background:#f4f6f8}
    .controls{display:flex; gap:8px; margin-top:8px}
    button{background:var(--accent); border:none; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    button.ghost{background:transparent; color:var(--accent); border:1px solid #ddeefc}
    .results-list{margin-top:12px; display:flex; flex-direction:column; gap:10px}
    .result{padding:10px; border-radius:8px; border:1px solid #f0f4f7}
    #map{height:540px; border-radius:12px; overflow:hidden}
    .places{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:12px}
    .place-card{background:linear-gradient(180deg,#fff,#fbfdff); padding:12px; border-radius:10px; box-shadow:0 6px 14px rgba(16,32,39,0.04);}
    .place-name{font-weight:700}
    .place-meta{font-size:13px; color:var(--muted)}
    footer{max-width:1200px;margin:8px auto 40px; color:var(--muted); font-size:13px}
    @media (max-width:940px){main{grid-template-columns:1fr; padding:12px} #map{height:420px}}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">FF</div>
      <div>
        <div class="title">FoodFinder</div>
        <div class="subtitle">Search meals from a photo • find nearby restaurants</div>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h3>Upload an image</h3>
      <div class="uploader">
        <div id="dropzone" class="dropzone">
          <div style="font-weight:600">Drag & drop a photo or click to browse</div>
          <div style="font-size:13px; color:var(--muted); margin-top:6px">Try a clear food photo — pizza, sushi, burger, etc.</div>
          <input id="fileInput" type="file" accept="image/*" style="display:none">
        </div>
        <img id="preview" class="preview" alt="preview" src="" style="display:none">
        <div class="controls">
          <button id="analyzeBtn" disabled>Analyze Photo</button>
          <button id="locateBtn" class="ghost">Use My Location</button>
        </div>
        <div id="status" style="font-size:13px; color:var(--muted); margin-top:8px">No image selected</div>
        <div id="labels" class="results-list"></div>
      </div>
      <div style="margin-top:20px">
        <label for="apiKey">OpenAI API Key:</label>
        <input id="apiKey" type="password" placeholder="Enter your OpenAI API key" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">
      </div>
    </section>

    <section>
      <div class="card">
        <h3>Nearby restaurants</h3>
        <div id="map"></div>
        <div id="places" class="places"></div>
      </div>
    </section>
  </main>

  <footer>Use your OpenAI API key above for image recognition integration.</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const drop=document.getElementById('dropzone');
    const fileInput=document.getElementById('fileInput');
    const preview=document.getElementById('preview');
    const analyzeBtn=document.getElementById('analyzeBtn');
    const status=document.getElementById('status');
    const labelsDiv=document.getElementById('labels');
    const apiKeyInput=document.getElementById('apiKey');
    const locateBtn=document.getElementById('locateBtn');
    const placesDiv=document.getElementById('places');

    const map=L.map('map').setView([40.4168,-3.7038],12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const markersLayer=L.layerGroup().addTo(map);

    let currentFile=null;
    let userCoords=null;

    drop.addEventListener('click',()=>fileInput.click());
    drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag');});
    drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
    drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');handleFile(e.dataTransfer.files[0]);});
    fileInput.addEventListener('change',e=>handleFile(e.target.files[0]));

    function handleFile(file){
      if(!file)return;
      currentFile=file;
      const url=URL.createObjectURL(file);
      preview.src=url;preview.style.display='block';
      status.textContent=`Selected: ${file.name}`;
      analyzeBtn.disabled=false;
    }

    locateBtn.addEventListener('click',()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          userCoords=[pos.coords.latitude,pos.coords.longitude];
          map.setView(userCoords,14);
          L.marker(userCoords).addTo(map).bindPopup('You are here').openPopup();
          status.textContent='Location acquired.';
        },()=>alert('Location access denied.'));
      } else alert('Geolocation not supported.');
    });

    analyzeBtn.addEventListener('click',async()=>{
      if(!currentFile)return alert('Please upload a food image first.');
      const apiKey=apiKeyInput.value.trim();
      if(!apiKey)return alert('Please enter your OpenAI API key first.');

      status.textContent='Analyzing image with OpenAI...';

      const base64Image=await toBase64(currentFile);

      const response=await fetch('https://api.openai.com/v1/responses',{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
        body:JSON.stringify({
          model:'gpt-4.1-mini',
          input:[{
            role:'user',
            content:[
              {type:'input_text',text:'Identify the type of food in this image. Give short labels (like pizza, sushi, pasta).'},
              {type:'input_image',image_url:base64Image}
            ]
          }]
        })
      });

      const result=await response.json();
      const textOutput=result.output_text||'No response';
      const labels=textOutput.split(/[,\n]/).map(x=>x.trim()).filter(Boolean);
      renderLabels(labels);
      status.textContent='Detected: '+labels.join(', ');
      if(userCoords) searchNearby(labels[0]);
    });

    function renderLabels(labels){
      labelsDiv.innerHTML='';
      labels.forEach(l=>{
        const el=document.createElement('div');el.className='result';el.textContent=l;labelsDiv.appendChild(el);
      });
    }

    function toBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.readAsDataURL(file);
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
      });
    }

    async function searchNearby(foodType){
      if(!userCoords)return alert('Please allow location and try again.');
      status.textContent=`Searching nearby restaurants for ${foodType}...`;
      markersLayer.clearLayers();
      placesDiv.innerHTML='';

      const [lat,lon]=userCoords;
      const query=`[out:json];node["amenity"="restaurant"](around:4000,${lat},${lon});out;`;
      const res=await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(query));
      const data=await res.json();

      let filtered=data.elements.filter(e=>{
        const name=e.tags.name||'';
        return name.toLowerCase().includes(foodType.toLowerCase());
      }).slice(0,20);

      if(!filtered.length){
        status.textContent=`No nearby ${foodType} restaurants found. Showing all nearby restaurants.`;
        filtered=data.elements.slice(0,20);
      }

      filtered.forEach(r=>{
        const marker=L.marker([r.lat,r.lon]).addTo(markersLayer).bindPopup(r.tags.name||'Unnamed');
        const card=document.createElement('div');
        card.className='place-card';
        card.innerHTML=`<div class='place-name'>${r.tags.name||'Unnamed'}</div><div class='place-meta'>${foodType} • ${(r.tags.addr_city||'Nearby')}</div>`;
        placesDiv.appendChild(card);
      });

      status.textContent=`Found ${filtered.length} nearby restaurants related to ${foodType}.`;
    }
  </script>
</body>
</html>
